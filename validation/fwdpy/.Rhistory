stochSA2 <- mean(filter(pop, focal)$news^2)
stochSA3 <- mean(filter(pop, focal)$news^3)
master <- bind_rows(master, data.frame(parentMeans,
parentx,
parentVs,
parentSA,
parentSA2,
parentSA3,
parentSA4,
targetSA,
stochx,
stochSA,
stochSA2,
stochSA3,
predSA,
predSA2,
predVarSA,
detSA,
detSA2))
}
return(master)
}
master <- doSim(vs, N,
sa,
targetVar,
x,
shape,
scale,
mu,
L,
rep = rep) %>%
mutate(x = x,
sa = sa,
vs = vs,
N = N,
shape = shape,
scale = scale,
mu = mu)
master <- master %>% mutate(stochChangex = stochx - parentx,
predChangex = predx - parentx,
detChangex = detx - parentx,
stochChangeSA = stochSA - parentSA,
predChangeSA = predSA - parentSA,
detChangeSA = detSA - parentSA,
stochChangeSA2 = stochSA2 - parentSA2,
predChangeSA2 = predSA2 - parentSA2,
detChangeSA2 = detSA2 - parentSA2,
stochChangeVs = stochVs - parentVs,
predChangeVs = predVs - parentVs)
doSim <- function(vs, N,
targetMean,
targetVar,
targetx,
shape,
scale,
mu,
L,
rep = 100,
reNormParents = T){
pop <- "womp"
suppressWarnings(
while(any(pop == "womp")){
pop <- getStartingPop(vs, N,
targetMean,
targetVar,
targetx)
}
)
if(reNormParents){
parentMF <- mean(1 + pop$s)
pop <- pop %>% mutate(s = ((1 + s) / parentMF) - 1)
}
parentMeans <- mean(pop$s)
parentVs <- var(pop$s)
parentx <- mean(pop$focal)
parentSA <- mean(filter(pop, focal)$s)
parentSA2 <- mean(filter(pop, focal)$s^2)
parentSA3 <- mean(filter(pop, focal)$s^3)
parentSA4 <- mean(filter(pop, focal)$s^4)
targetSA <- targetMean
popsave <- pop
# predicted next gen
predx <- parentx
predSA = parentSA
predSA2 = (1 - mu * L * shape * scale)^(-2) *
(mu * L * (shape^2 * scale^2 * (1 - mu) + shape * scale^2) +
2 *  parentSA * mu * L * (shape^2 * scale^2 * (1 - mu) + shape * scale^2) +
parentSA2 * (1 + mu * L *
(- 2 * shape * scale + shape^2 * scale^2 * (1 + mu * (L - 1)) + shape * scale^2))
)
predVarSA = mu * L * (shape^2 * scale ^2 * (1 - mu) + shape * scale^2) *
(1 + mu * L * shape * scale)^2 * (1 + 2 * parentSA + parentSA2) /
(2 * N * targetx)
# deterministic next gen
if(mu * L %% 1 == 0){
sM = ((1 + pop$s) * prod(1 - rep(shape * scale, mu * L))) - 1
meanFit <- mean(1 + sM)
sPrime <- ((1 + sM) / meanFit) - 1
detSA <- sum(pop$focal * sPrime) / sum(pop$focal)
detSA2 <- sum(pop$focal * sPrime^2) / sum(pop$focal)
}else{
detSA <- detSA2 <- NA
}
master <- data.frame()
for(i in 1:rep){
pop <- popsave
# stochastic next gen
pop$numMuts <- rbinom(2 * N, L, mu)
newfit = rep(0, times = nrow(pop))
for(i in 1:nrow(pop)){
newfit[i] = (1+pop$s[i]) * prod(1 - rgamma(pop$numMuts[i],
shape = shape,
scale = scale)) # look at constant dfe
}
pop$newfit <- newfit
meanfit <- mean(newfit)
pop$news <- ((newfit) / meanfit) - 1
stochx <- mean(pop$focal)
stochSA <- mean(filter(pop, focal)$news)
stochSA2 <- mean(filter(pop, focal)$news^2)
stochSA3 <- mean(filter(pop, focal)$news^3)
master <- bind_rows(master, data.frame(parentMeans,
parentx,
parentVs,
parentSA,
parentSA2,
parentSA3,
parentSA4,
targetSA,
stochx,
stochSA,
stochSA2,
stochSA3,
predx,
predSA,
predSA2,
predVarSA,
detSA,
detSA2))
}
return(master)
}
master <- doSim(vs, N,
sa,
targetVar,
x,
shape,
scale,
mu,
L,
rep = rep) %>%
mutate(x = x,
sa = sa,
vs = vs,
N = N,
shape = shape,
scale = scale,
mu = mu)
master <- master %>% mutate(stochChangex = stochx - parentx,
predChangex = predx - parentx,
detChangex = detx - parentx,
stochChangeSA = stochSA - parentSA,
predChangeSA = predSA - parentSA,
detChangeSA = detSA - parentSA,
stochChangeSA2 = stochSA2 - parentSA2,
predChangeSA2 = predSA2 - parentSA2,
detChangeSA2 = detSA2 - parentSA2,
stochChangeVs = stochVs - parentVs,
predChangeVs = predVs - parentVs)
master <- master %>% mutate(stochChangex = stochx - parentx,
predChangex = predx - parentx,
stochChangeSA = stochSA - parentSA,
predChangeSA = predSA - parentSA,
detChangeSA = detSA - parentSA,
stochChangeSA2 = stochSA2 - parentSA2,
predChangeSA2 = predSA2 - parentSA2,
detChangeSA2 = detSA2 - parentSA2,
stochChangeVs = stochVs - parentVs,
predChangeVs = predVs - parentVs)
doSim <- function(vs, N,
targetMean,
targetVar,
targetx,
shape,
scale,
mu,
L,
rep = 100,
reNormParents = T){
pop <- "womp"
suppressWarnings(
while(any(pop == "womp")){
pop <- getStartingPop(vs, N,
targetMean,
targetVar,
targetx)
}
)
if(reNormParents){
parentMF <- mean(1 + pop$s)
pop <- pop %>% mutate(s = ((1 + s) / parentMF) - 1)
}
parentMeans <- mean(pop$s)
parentVs <- var(pop$s)
parentx <- mean(pop$focal)
parentSA <- mean(filter(pop, focal)$s)
parentSA2 <- mean(filter(pop, focal)$s^2)
parentSA3 <- mean(filter(pop, focal)$s^3)
parentSA4 <- mean(filter(pop, focal)$s^4)
targetSA <- targetMean
popsave <- pop
# predicted next gen
predx <- parentx
predSA = parentSA
predSA2 = (1 - mu * L * shape * scale)^(-2) *
(mu * L * (shape^2 * scale^2 * (1 - mu) + shape * scale^2) +
2 *  parentSA * mu * L * (shape^2 * scale^2 * (1 - mu) + shape * scale^2) +
parentSA2 * (1 + mu * L *
(- 2 * shape * scale + shape^2 * scale^2 * (1 + mu * (L - 1)) + shape * scale^2))
)
predVarSA = mu * L * (shape^2 * scale ^2 * (1 - mu) + shape * scale^2) *
(1 + mu * L * shape * scale)^2 * (1 + 2 * parentSA + parentSA2) /
(2 * N * targetx)
# deterministic next gen
if(mu * L %% 1 == 0){
sM = ((1 + pop$s) * prod(1 - rep(shape * scale, mu * L))) - 1
meanFit <- mean(1 + sM)
sPrime <- ((1 + sM) / meanFit) - 1
detSA <- sum(pop$focal * sPrime) / sum(pop$focal)
detSA2 <- sum(pop$focal * sPrime^2) / sum(pop$focal)
}else{
detSA <- detSA2 <- NA
}
master <- data.frame()
for(i in 1:rep){
pop <- popsave
# stochastic next gen
pop$numMuts <- rbinom(2 * N, L, mu)
newfit = rep(0, times = nrow(pop))
for(i in 1:nrow(pop)){
newfit[i] = (1+pop$s[i]) * prod(1 - rgamma(pop$numMuts[i],
shape = shape,
scale = scale)) # look at constant dfe
}
pop$newfit <- newfit
meanfit <- mean(newfit)
pop$news <- ((newfit) / meanfit) - 1
stochx <- mean(pop$focal)
stochSA <- mean(filter(pop, focal)$news)
stochSA2 <- mean(filter(pop, focal)$news^2)
stochSA3 <- mean(filter(pop, focal)$news^3)
stochVs <- mean(pop$news^2)
master <- bind_rows(master, data.frame(parentMeans,
parentx,
parentVs,
parentSA,
parentSA2,
parentSA3,
parentSA4,
targetSA,
stochx,
stochSA,
stochSA2,
stochSA3,
stochVs,
predx,
predSA,
predSA2,
predVarSA,
detSA,
detSA2))
}
return(master)
}
master <- doSim(vs, N,
sa,
targetVar,
x,
shape,
scale,
mu,
L,
rep = rep) %>%
mutate(x = x,
sa = sa,
vs = vs,
N = N,
shape = shape,
scale = scale,
mu = mu)
master <- master %>% mutate(stochChangex = stochx - parentx,
predChangex = predx - parentx,
stochChangeSA = stochSA - parentSA,
predChangeSA = predSA - parentSA,
detChangeSA = detSA - parentSA,
stochChangeSA2 = stochSA2 - parentSA2,
predChangeSA2 = predSA2 - parentSA2,
detChangeSA2 = detSA2 - parentSA2,
stochChangeVs = stochVs - parentVs,
predChangeVs = predVs - parentVs)
master <- master %>% mutate(stochChangex = stochx - parentx,
predChangex = predx - parentx,
stochChangeSA = stochSA - parentSA,
predChangeSA = predSA - parentSA,
detChangeSA = detSA - parentSA,
stochChangeSA2 = stochSA2 - parentSA2,
predChangeSA2 = predSA2 - parentSA2,
detChangeSA2 = detSA2 - parentSA2,
stochChangeVs = stochVs - parentVs)
print(paste(25 * 25 * 2 * 2, "* reps different simulations"))
library(dplyr)
library(data.table)
master <- data.frame()
for(N in c(1e3,1e4)){
for(L in c(35e3,1e5,5e5,1e6)){
for(r in c(0,1e-8)){
seed <- sample(1:1e6,1)
master <- master %>% bind_rows(.,
data.frame(seed,
N,
L,
r))
}
}
}
write.table(master, file = "fwdpyparams.txt",
row.names = F,col.names = F, quote=F)
library(dplyr)
library(data.table)
master <- data.frame()
for(L in seq(10^7,5*10^7, by = 5e6)){
for(abar in -seq(5e-4, 5e-3, by = 5e-4)){
for(mu in c(1e-10,1e-9,seq(2e-9, 1e-8,by=1e-9))){
for(r in c(0,1e-8)){
for(Q in c(2,4)){
seed <- sample(1:1e6,1)
scale = 0.01
shape = abs(abar / scale)
master <- dplyr::bind_rows(master,
data.frame(seed,
Q,
r,
shape,
abar,
L,
mu))
}
}
}
}
}
master <- data.frame()
for(L in seq(10^7,5*10^7, by = 5e6)){
for(abar in -seq(5e-4, 5e-3, by = 5e-4)){
for(mu in c(1e-10,1e-9,seq(2e-9, 1e-8,by=1e-9))){
for(r in c(0,1e-8)){
for(Q in c(2,4)){
seed <- sample(1:1e6,1)
scale = 0.01
shape = abs(abar / scale)
master <- dplyr::bind_rows(master,
data.frame(seed,
Q,
r,
shape,
abar,
L,
mu))
}
}
}
}
}
master$tag <- 1:nrow(master)
head(master)
master[[875,885:]]
master[[875,885,]]
master[[875:885,]]
master[[875:885]]
master[[875:885,:]]
master[875:885,]
unique(master$a abar)
unique(master$abar)
master[275:285,]
library(dplyr)
library(data.table)
master <- data.frame()
for(L in seq(10^7,5*10^7, by = 5e6)){
for(abar in -seq(5e-4, 5e-3, by = 5e-4)){
for(mu in c(1e-10,1e-9,seq(2e-9, 1e-8,by=1e-9))){
for(r in c(0,1e-8)){
seed <- sample(1:1e6,1)
scale = 0.01
shape = abs(abar / scale)
master <- dplyr::bind_rows(master,
data.frame(seed,
r,
shape,
abar,
L,
mu))
}
}
}
}
master$tag <- 1:nrow(master)
library(dplyr)
library(data.table)
master <- data.frame()
for(L in seq(10^7,5*10^7, by = 5e6)){
for(abar in -seq(5e-4, 5e-3, by = 5e-4)){
for(mu in c(1e-10,1e-9,seq(2e-9, 1e-8,by=1e-9))){
for(r in c(0,1e-8)){
seed <- sample(1:1e6,1)
scale = 0.01
shape = abs(abar / scale)
master <- dplyr::bind_rows(master,
data.frame(seed,
r,
shape,
abar,
L,
mu))
}
}
}
}
master$tag <- 1:nrow(master)
master <- data.frame()
for(L in seq(10^7,5*10^7, by = 5e6)){
for(abar in -seq(5e-4, 5e-3, by = 5e-4)){
for(mu in c(1e-10,1e-9,seq(2e-9, 1e-8,by=1e-9))){
for(r in c(0,1e-8)){
seed <- sample(1:1e6,1)
scale = 0.01
shape = abs(abar / scale)
master <- dplyr::bind_rows(master,
data.frame(seed,
r,
shape,
abar,
L,
mu))
}
}
}
}
library(dplyr)
library(data.table)
master <- data.frame()
for(L in seq(10^7,5*10^7, by = 5e6)){
for(abar in -seq(5e-4, 5e-3, by = 5e-4)){
for(mu in c(1e-10,1e-9,seq(2e-9, 1e-8,by=1e-9))){
for(r in c(0,1e-8)){
seed <- sample(1:1e6,1)
scale = 0.01
shape = abs(abar / scale)
master <- dplyr::bind_rows(master,
data.frame(seed,
r,
shape,
abar,
L,
mu))
}
}
}
}
master[1726]
master[1726,]
4.5e7*4e-9
library(dplyr)
library(data.table)
master <- data.frame()
for(L in seq(10^7,1*10^8, by = 5e6)){
for(abar in -seq(5e-4, 5e-3, by = 5e-4)){
for(mu in c(1e-10,1e-9,seq(2e-9, 1e-8,by=1e-9))){
for(nRec in c(-1,1,2)){
seed <- sample(1:1e6,1)
scale = 0.01
shape = abs(abar / scale)
master <- dplyr::bind_rows(master,
data.frame(seed,
nRec,
shape,
abar,
L,
mu))
}
}
}
}
master$tag <- 1:nrow(master)
write.table(master, file = "changeInSir.txt",
row.names = F,col.names = F,quote=F)
warnings()
install.packages("dplyr")
setwd("~/Documents/GitHub/BGSdemo/validation/fwdpy")
library(dplyr)
master <- data.frame()
for(s in c(1e-3,5e-3,1e-2)){
for(n in c(1e3,5e3,1e4)){
for(rep in 1:100){
master <- dplyr::bind_rows(master,
data.frame(s,
n))
}
}
}
master$seed <- sample(1:1e4,nrow(master))
write.table(master, file = "params.txt",
row.names = F,col.names = F, quote=F)
